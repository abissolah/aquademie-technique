{% extends 'base.html' %}
{% block title %}Créer les palanquées - {{ seance.date|date:'d/m/Y' }}{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Créer les palanquées pour la séance du {{ seance.date|date:'d/m/Y' }}</h2>
    <p><strong>Lieu :</strong> {{ seance.lieu.nom }}<br>
    <strong>Directeur de plongée :</strong> {% if seance.directeur_plongee %}{{ seance.directeur_plongee.nom_complet }} ({{ seance.directeur_plongee.get_niveau_display }}){% else %}<span class="text-muted">Non défini</span>{% endif %}</p>
    <form id="form-palanquees" method="post">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="table-palanquees">
                <thead>
                    <tr>
                        <th>Nom Prénom</th>
                        <th>Niveau</th>
                        <th>Section</th>
                        <th>Aptitude</th>
                        {% for moniteur in encadrants %}
                            <th class="text-center">
                                {{ moniteur.nom }} {{ moniteur.prenom }}<br>
                                <span class="badge bg-info">{{ moniteur.get_niveau_display }}</span>
                                <div class="mt-2">
                                    <input type="number" name="profondeur_max_{{ moniteur.id }}" class="form-control form-control-sm mb-1" placeholder="Profondeur max" min="0">
                                    <input type="number" name="duree_max_{{ moniteur.id }}" class="form-control form-control-sm" placeholder="Durée max (min)" min="0">
                                </div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in eleves %}
                    <tr>
                        <td>{{ eleve.nom }} {{ eleve.prenom }}</td>
                        <td>{{ eleve.get_niveau_display }}</td>
                        <td>{% for s in eleve.sections.all %}<span class="badge bg-info me-1">{{ s.get_nom_display }}</span>{% endfor %}</td>
                        <td><input type="text" name="aptitude_{{ eleve.id }}" class="form-control form-control-sm"></td>
                        {% for moniteur in encadrants %}
                        <td class="text-center">
                            <input type="checkbox" name="affectation_{{ eleve.id }}_{{ moniteur.id }}" class="affectation-checkbox" data-eleve="{{ eleve.id }}" data-moniteur="{{ moniteur.id }}">
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'seance_detail' seance.pk %}" class="btn btn-secondary">Annuler</a>
            <button type="submit" class="btn btn-success">Enregistrer les palanquées</button>
        </div>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // JS pour griser les autres cases si une case est cochée pour un élève
    document.querySelectorAll('.affectation-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const eleveId = this.dataset.eleve;
            if (this.checked) {
                document.querySelectorAll('.affectation-checkbox[data-eleve="' + eleveId + '"]').forEach(function(cb) {
                    if (cb !== checkbox) {
                        cb.disabled = true;
                    }
                });
            } else {
                document.querySelectorAll('.affectation-checkbox[data-eleve="' + eleveId + '"]').forEach(function(cb) {
                    cb.disabled = false;
                });
            }
        });
    });
});
</script>
{% endblock %}

