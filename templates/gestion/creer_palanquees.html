{% extends 'base.html' %}
{% load gestion_extras %}
{% block title %}Créer les palanquées - {{ seance.date|date:'d/m/Y' }}{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Créer les palanquées pour la séance du {{ seance.date|date:'d/m/Y' }}</h2>
    <p><strong>Lieu :</strong> {{ seance.lieu.nom }}<br>
    <strong>Directeur de plongée :</strong> {% if seance.directeur_plongee %}{{ seance.directeur_plongee.nom_complet }} ({{ seance.directeur_plongee.get_niveau_display }}){% else %}<span class="text-muted">Non défini</span>{% endif %}</p>
    <form id="form-palanquees" method="post">
        {% csrf_token %}
        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary" id="add-autonome-col">Ajouter une palanquée d'autonomes</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="table-palanquees">
                <thead>
                    <tr>
                        <th class="sticky-col sticky-col-1">Nom Prénom</th>
                        <th class="sticky-col sticky-col-2">Niveau</th>
                        <th class="sticky-col sticky-col-3">Section</th>
                        <th class="sticky-col sticky-col-4">Aptitude</th>
                        {% for moniteur in encadrants %}
                            {% with param=encadrant_settings|dict_get:moniteur.id %}
                            <th class="text-center">
                                {{ moniteur.nom }} {{ moniteur.prenom }}<br>
                                <span class="badge bg-info">{{ moniteur.get_niveau_display }}</span>
                                <div class="mt-2">
                                    <input type="number" name="profondeur_max_{{ moniteur.id }}" class="form-control form-control-sm mb-1" placeholder="Profondeur max" min="0" value="{{ param.profondeur_max|default_if_none:'' }}">
                                    <input type="number" name="duree_max_{{ moniteur.id }}" class="form-control form-control-sm" placeholder="Durée max (min)" min="0" value="{{ param.duree_max|default:40 }}">
                                </div>
                            </th>
                            {% endwith %}
                        {% endfor %}
                        {% for auto in autonomes_data %}
                            <th class="text-center autonome-th" data-autonome-num="{{ auto.num }}">
                                Autonomes n°{{ auto.num }}<br><span class="badge bg-secondary">Sans encadrant</span>
                                <div class="mt-2">
                                    <input type="number" name="profondeur_max_autonome_{{ auto.num }}" class="form-control form-control-sm mb-1" placeholder="Profondeur max" min="0" value="{{ auto.profondeur_max|default_if_none:'' }}">
                                    <input type="number" name="duree_max_autonome_{{ auto.num }}" class="form-control form-control-sm" placeholder="Durée max (min)" min="0" value="{{ auto.duree_max|default:40 }}">
                                </div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in eleves %}
                    <tr data-eleve-id="{{ eleve.id }}">
                        <td class="sticky-col sticky-col-1">{{ eleve.nom }} {{ eleve.prenom }}</td>
                        <td class="sticky-col sticky-col-2">{{ eleve.get_niveau_display }}</td>
                        <td class="sticky-col sticky-col-3">{% for s in eleve.sections.all %}<span class="badge bg-info me-1">{{ s.get_nom_display }}</span>{% endfor %}</td>
                        <td class="sticky-col sticky-col-4">
                            {% with current_aptitude=existing_aptitudes|dict_get:eleve.id %}
                            <select name="aptitude_{{ eleve.id }}" class="form-select form-select-sm">
                                <option value="">---</option>
                                <option value="bapteme" {% if current_aptitude == 'bapteme' %}selected{% endif %}>Baptême</option>
                                <option value="PE12" {% if current_aptitude == 'PE12' %}selected{% endif %}>PE12</option>
                                <option value="PE20" {% if current_aptitude == 'PE20' %}selected{% endif %}>PE20</option>
                                <option value="PA20" {% if current_aptitude == 'PA20' %}selected{% endif %}>PA20</option>
                                <option value="PE40" {% if current_aptitude == 'PE40' %}selected{% endif %}>PE40</option>
                                <option value="PA40" {% if current_aptitude == 'PA40' %}selected{% endif %}>PA40</option>
                                <option value="PA60" {% if current_aptitude == 'PA60' %}selected{% endif %}>PA60</option>
                                <option value="GP" {% if current_aptitude == 'GP' %}selected{% endif %}>GP</option>
                                <option value="E1" {% if current_aptitude == 'E1' %}selected{% endif %}>E1</option>
                                <option value="E2" {% if current_aptitude == 'E2' %}selected{% endif %}>E2</option>
                                <option value="E3" {% if current_aptitude == 'E3' %}selected{% endif %}>E3</option>
                                <option value="E4" {% if current_aptitude == 'E4' %}selected{% endif %}>E4</option>
                                
                            </select>
                            {% endwith %}
                        </td>
                        {% with affectations=existing_affectations|dict_get:eleve.id %}
                            {% for moniteur in encadrants %}
                            <td class="text-center">
                                <input type="checkbox" name="affectation_{{ eleve.id }}_{{ moniteur.id }}" class="affectation-checkbox" data-eleve="{{ eleve.id }}" data-moniteur="{{ moniteur.id }}" {% if affectations and moniteur.id in affectations %}checked{% endif %}>
                            </td>
                            {% endfor %}
                        {% endwith %}
                        {% for auto in autonomes_data %}
                        <td class="text-center autonome-td">
                            <input type="checkbox" name="affectation_autonome_{{ auto.num }}_{{ eleve.id }}" class="affectation-autonome-checkbox" data-eleve="{{ eleve.id }}" data-autonome="{{ auto.num }}" {% if auto.eleves and eleve.id in auto.eleves %}checked{% endif %}>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'seance_detail' seance.pk %}" class="btn btn-secondary">Annuler</a>
            <button type="submit" class="btn btn-success">Enregistrer les palanquées</button>
        </div>
    </form>
</div>
<style>
tr.eleve-assigne > td,
tr.eleve-assigne > th {
    background-color: #dff5d8 !important;
}
tr.eleve-assigne .sticky-col {
    background-color: #dff5d8 !important;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateEleveRowHighlight(eleveId) {
        const row = document.querySelector(`tr[data-eleve-id="${eleveId}"]`);
        if (!row) return;
        const relatedCheckboxes = document.querySelectorAll(`[data-eleve="${eleveId}"]`);
        const isChecked = Array.from(relatedCheckboxes).some(cb => cb.checked);
        row.classList.toggle('eleve-assigne', isChecked);
    }

    const table = document.getElementById('table-palanquees');
    const addAutonomeBtn = document.getElementById('add-autonome-col');
    let autonomeCount = {{ autonome_count|default:0 }};

    const updateCheckboxState = (eleveId) => {
        const checkboxes = document.querySelectorAll('[data-eleve="' + eleveId + '"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        checkboxes.forEach(cb => {
            if (checked.length > 0) {
                cb.disabled = !cb.checked;
            } else {
                cb.disabled = false;
            }
        });
    };

    const registerCheckbox = (checkbox) => {
        checkbox.addEventListener('change', function() {
            const eleveId = this.dataset.eleve;
            if (this.checked) {
                document.querySelectorAll('[data-eleve="' + eleveId + '"]').forEach(cb => {
                    if (cb !== this) {
                        cb.checked = false;
                    }
                });
            }
            updateCheckboxState(eleveId);
            updateEleveRowHighlight(eleveId);
        });
    };

    document.querySelectorAll('.affectation-checkbox, .affectation-autonome-checkbox').forEach(cb => {
        registerCheckbox(cb);
    });

    // Appliquer l'état initial pour désactiver les cases non sélectionnées
    const eleveIds = new Set();
    document.querySelectorAll('.affectation-checkbox, .affectation-autonome-checkbox').forEach(cb => {
        eleveIds.add(cb.dataset.eleve);
    });
    eleveIds.forEach(updateCheckboxState);
    eleveIds.forEach(updateEleveRowHighlight);

    addAutonomeBtn.addEventListener('click', function() {
        autonomeCount++;
        const theadRow = table.querySelector('thead tr');
        const th = document.createElement('th');
        th.className = 'text-center autonome-th';
        th.innerHTML = `Autonomes n°${autonomeCount}<br><span class="badge bg-secondary">Sans encadrant</span>
            <div class="mt-2">
                <input type="number" name="profondeur_max_autonome_${autonomeCount}" class="form-control form-control-sm mb-1" placeholder="Profondeur max" min="0">
                <input type="number" name="duree_max_autonome_${autonomeCount}" class="form-control form-control-sm" placeholder="Durée max (min)" value="40" min="0">
            </div>`;
        theadRow.appendChild(th);
        const tbodyRows = table.querySelectorAll('tbody tr');
        tbodyRows.forEach(function(row) {
            const eleveId = row.dataset.eleveId;
            const td = document.createElement('td');
            td.className = 'text-center autonome-td';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = `affectation_autonome_${autonomeCount}_${eleveId}`;
            checkbox.className = 'affectation-autonome-checkbox';
            checkbox.dataset.eleve = eleveId;
            checkbox.dataset.autonome = autonomeCount;
            registerCheckbox(checkbox);
            td.appendChild(checkbox);
            row.appendChild(td);
            updateCheckboxState(eleveId);
            updateEleveRowHighlight(eleveId);
        });
    });

    document.getElementById('form-palanquees').addEventListener('submit', function(e) {
        const checkboxes = document.querySelectorAll('.affectation-checkbox, .affectation-autonome-checkbox');
        const auMoinsUneCochee = Array.from(checkboxes).some(cb => cb.checked);
        if (!auMoinsUneCochee) {
            e.preventDefault();
            alert('Veuillez cocher au moins une case dans une colonne moniteur ou autonome pour créer au moins une palanquée.');
            return;
        }
        const confirmation = confirm('Toutes les palanquées existantes pour cette séance seront supprimées et remplacées par cette configuration. Voulez-vous continuer ?');
        if (!confirmation) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}

