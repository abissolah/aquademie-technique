{% extends 'base.html' %}
{% block title %}Créer les palanquées - {{ seance.date|date:'d/m/Y' }}{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Créer les palanquées pour la séance du {{ seance.date|date:'d/m/Y' }}</h2>
    <p><strong>Lieu :</strong> {{ seance.lieu.nom }}<br>
    <strong>Directeur de plongée :</strong> {% if seance.directeur_plongee %}{{ seance.directeur_plongee.nom_complet }} ({{ seance.directeur_plongee.get_niveau_display }}){% else %}<span class="text-muted">Non défini</span>{% endif %}</p>
    <form id="form-palanquees" method="post">
        {% csrf_token %}
        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary" id="add-autonome-col">Ajouter une palanquée d'autonomes</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="table-palanquees">
                <thead>
                    <tr>
                        <th class="sticky-col sticky-col-1">Nom Prénom</th>
                        <th class="sticky-col sticky-col-2">Niveau</th>
                        <th class="sticky-col sticky-col-3">Section</th>
                        <th class="sticky-col sticky-col-4">Aptitude</th>
                        {% for moniteur in encadrants %}
                            <th class="text-center">
                                {{ moniteur.nom }} {{ moniteur.prenom }}<br>
                                <span class="badge bg-info">{{ moniteur.get_niveau_display }}</span>
                                <div class="mt-2">
                                    <input type="number" name="profondeur_max_{{ moniteur.id }}" class="form-control form-control-sm mb-1" placeholder="Profondeur max" min="0">
                                    <input type="number" name="duree_max_{{ moniteur.id }}" class="form-control form-control-sm" placeholder="Durée max (min)" min="0" value="40">
                                </div>
                            </th>
                        {% endfor %}
                        <!-- Colonnes autonomes dynamiques -->
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in eleves %}
                    <tr>
                        <td class="sticky-col sticky-col-1">{{ eleve.nom }} {{ eleve.prenom }}</td>
                        <td class="sticky-col sticky-col-2">{{ eleve.get_niveau_display }}</td>
                        <td class="sticky-col sticky-col-3">{% for s in eleve.sections.all %}<span class="badge bg-info me-1">{{ s.get_nom_display }}</span>{% endfor %}</td>
                        <td class="sticky-col sticky-col-4">
                            <select name="aptitude_{{ eleve.id }}" class="form-select form-select-sm">
                                <option value="">---</option>
                                <option value="bapteme">Baptême</option>
                                <option value="PE12">PE12</option>
                                <option value="PE20">PE20</option>
                                <option value="PA20">PA20</option>
                                <option value="PE40">PE40</option>
                                <option value="PA40">PA40</option>
                                <option value="PA60">PA60</option>
                                <option value="GP">GP</option>
                                <option value="E1">E1</option>
                                <option value="E2">E2</option>
                                <option value="E3">E3</option>
                                <option value="E4">E4</option>
                                
                            </select>
                        </td>
                        {% for moniteur in encadrants %}
                        <td class="text-center">
                            <input type="checkbox" name="affectation_{{ eleve.id }}_{{ moniteur.id }}" class="affectation-checkbox" data-eleve="{{ eleve.id }}" data-moniteur="{{ moniteur.id }}">
                        </td>
                        {% endfor %}
                        <!-- Cases autonomes dynamiques -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'seance_detail' seance.pk %}" class="btn btn-secondary">Annuler</a>
            <button type="submit" class="btn btn-success">Enregistrer les palanquées</button>
        </div>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // JS pour griser les autres cases si une case est cochée pour un élève
    document.querySelectorAll('.affectation-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const eleveId = this.dataset.eleve;
            if (this.checked) {
                document.querySelectorAll('.affectation-checkbox[data-eleve="' + eleveId + '"]').forEach(function(cb) {
                    if (cb !== checkbox) {
                        cb.disabled = true;
                    }
                });
            } else {
                document.querySelectorAll('.affectation-checkbox[data-eleve="' + eleveId + '"]').forEach(function(cb) {
                    cb.disabled = false;
                });
            }
        });
    });

    // Gestion des colonnes autonomes dynamiques
    let autonomeCount = 0;
    const table = document.getElementById('table-palanquees');
    const addAutonomeBtn = document.getElementById('add-autonome-col');
    addAutonomeBtn.addEventListener('click', function() {
        autonomeCount++;
        // Ajout de l'en-tête
        const theadRow = table.querySelector('thead tr');
        const th = document.createElement('th');
        th.className = 'text-center autonome-th';
        th.innerHTML = `Autonomes n°${autonomeCount}<br><span class="badge bg-secondary">Sans encadrant</span>
            <div class="mt-2">
                <input type="number" name="profondeur_max_autonome_${autonomeCount}" class="form-control form-control-sm mb-1" placeholder="Profondeur max" min="0">
                <input type="number" name="duree_max_autonome_${autonomeCount}" class="form-control form-control-sm" placeholder="Durée max (min)" value="40" min="0">
            </div>`;
        theadRow.appendChild(th);
        // Ajout des cases à cocher pour chaque élève
        const tbodyRows = table.querySelectorAll('tbody tr');
        tbodyRows.forEach(function(row) {
            const td = document.createElement('td');
            td.className = 'text-center autonome-td';
            const eleveId = row.querySelector('input[name^="affectation_"]')?.dataset.eleve || row.querySelector('select[name^="aptitude_"]')?.name.split('_')[1];
            td.innerHTML = `<input type="checkbox" name="affectation_autonome_${autonomeCount}_${eleveId}" class="affectation-autonome-checkbox" data-eleve="${eleveId}" data-autonome="${autonomeCount}">`;
            row.appendChild(td);
        });
    });

    // Gestion de l'exclusivité des affectations (encadrant/autonome)
    document.addEventListener('change', function(e) {
        debugger;
        if (e.target.classList.contains('affectation-autonome-checkbox')) {
            const eleveId = e.target.dataset.eleve;
            if (e.target.checked) {
                // Désactive toutes les autres cases pour cet élève
                document.querySelectorAll('[data-eleve="' + eleveId + '"]').forEach(function(cb) {
                    if (cb !== e.target) {
                        cb.disabled = true;
                    }
                });
            } else {
                document.querySelectorAll('[data-eleve="' + eleveId + '"]').forEach(function(cb) {
                    cb.disabled = false;
                });
            }
        }
    });
});
</script>
{% endblock %}

