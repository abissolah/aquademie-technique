{% extends 'base.html' %}
{% block title %}Inscription à la séance - Club de Plongée{% endblock %}
{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm mb-4">
                <div class="card-header text-center">
                    <h2 class="mb-0">Inscription à la séance du {{ seance.date|date:'d/m/Y' }}</h2>
                    <h3 class="mb-0">à {{ seance.lieu.nom }} ({{ seance.heure_debut|default:'--'|time:'H:i' }})</h3>
                </div>
                <div class="card-body text-center">
                    <h5 class="mb-4">Êtes-vous adhérent du club APP ?</h5>
                    <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                        <a href="#" id="btn-adherent" class="btn btn-primary btn-lg px-4">Je suis adhérent APP</a>
                        <a href="#" id="btn-non-adherent" class="btn btn-outline-primary btn-lg px-4">Je ne suis pas adhérent APP</a>
                    </div>
                </div>
            </div>
            <div id="inscription-adherent" style="display:none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sélectionnez votre nom dans la liste des adhérents</h5>
                    </div>
                    <div class="card-body">
                        <input type="text" id="recherche-adherent" class="form-control mb-3" placeholder="Rechercher par nom ou prénom...">
                        <div id="liste-adherents" class="list-group mb-3" style="max-height:300px;overflow:auto;"></div>
                        <div id="infos-adherent" style="display:none;"></div>
                    </div>
                </div>
            </div>
            <div id="inscription-non-adherent" style="display:none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Formulaire d'inscription pour les non-adhérents</h5>
                    </div>
                    <div class="card-body">
                        <form id="form-non-adherent" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Type d'inscription :</label>
                                <div>
                                    <input type="radio" name="type_non_adherent" id="type-bapteme" value="bapteme">
                                    <label for="type-bapteme" class="me-3">Je suis débutant (baptême)</label>
                                    <input type="radio" name="type_non_adherent" id="type-plongeur" value="plongeur">
                                    <label for="type-plongeur">Je suis plongeur / encadrant</label>
                                </div>
                            </div>
                            <div id="bloc-form-non-adherent" style="display:none;">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label for="nm-selection-personne" class="form-label">Si vous vous êtes déjà inscrit à une séance, veuillez sélectionner votre nom dans la liste ci-dessous avant de remplir le formulaire</label>
                                        <select id="nm-selection-personne" class="form-control">
                                            <option value="">-- Aucune sélection --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="button" id="btn-charger-donnees" class="btn btn-primary w-100" disabled>Charger les données</button>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label for="nm-nom" class="form-label">Nom</label>
                                        <input type="text" name="nom" id="nm-nom" class="form-control" placeholder="Nom" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-prenom" class="form-label">Prénom</label>
                                        <input type="text" name="prenom" id="nm-prenom" class="form-control" placeholder="Prénom" required>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label for="nm-email" class="form-label">Email</label>
                                        <input type="email" name="email" id="nm-email" class="form-control" placeholder="Email" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-telephone" class="form-label">Téléphone</label>
                                        <input type="text" name="telephone" id="nm-telephone" class="form-control" placeholder="Téléphone" required>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label for="nm-date-naissance" class="form-label">Date de naissance</label>
                                        <input type="date" name="date_naissance" id="nm-date-naissance" class="form-control" placeholder="Date de naissance">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-adresse" class="form-label">Adresse</label>
                                        <input type="text" name="adresse" id="nm-adresse" class="form-control" placeholder="Adresse">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label for="nm-code-postal" class="form-label">Code postal</label>
                                        <input type="text" name="code_postal" id="nm-code-postal" class="form-control" placeholder="Code postal">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="nm-ville" class="form-label">Ville</label>
                                        <input type="text" name="ville" id="nm-ville" class="form-control" placeholder="Ville">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-numero-licence" class="form-label">Numéro de licence</label>
                                        <input type="text" name="numero_licence" id="nm-numero-licence" class="form-control" placeholder="Numéro de licence">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-assurance" class="form-label">Assurance</label>
                                        <select name="assurance" id="nm-assurance" class="form-control">
                                            <option value="">Aucune assurance</option>
                                            <option value="Piscine">Piscine</option>
                                            <option value="Loisir 1">Loisir 1</option>
                                            <option value="Loisir 2">Loisir 2</option>
                                            <option value="Loisir 3">Loisir 3</option>
                                            <option value="Loisir Top 1">Loisir Top 1</option>
                                            <option value="Loisir Top 2">Loisir Top 2</option>
                                            <option value="Loisir Top 3">Loisir Top 3</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-2" id="bloc-caci-fields">
                                    <div class="col-md-6">
                                        <label for="nm-date-delivrance-caci" class="form-label">Date de délivrance du CACI</label>
                                        <input type="date" name="date_delivrance_caci" id="nm-date-delivrance-caci" class="form-control" placeholder="Date de délivrance du CACI">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-caci-fichier" class="form-label">Fichier CACI</label>
                                        <input type="file" name="caci_fichier" id="nm-caci-fichier" class="form-control">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label for="nm-niveau" class="form-label">Niveau</label>
                                        <select name="niveau" id="nm-niveau" class="form-control" required>
                                            <option value="">Niveau</option>
                                            <option value="debutant">Débutant</option>
                                            <option value="niveau1">Niveau 1</option>
                                            <option value="niveau2">Niveau 2</option>
                                            <option value="niveau3">Niveau 3</option>
                                            <option value="initiateur1">Initiateur 1</option>
                                            <option value="initiateur2">Initiateur 2</option>
                                            <option value="moniteur_federal1">Moniteur fédéral 1</option>
                                            <option value="moniteur_federal2">Moniteur fédéral 2</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-statut" class="form-label">Statut</label>
                                        <select name="statut" id="nm-statut" class="form-control" required>
                                            <option value="eleve">Élève</option>
                                            <option value="encadrant">Encadrant</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Suppression du bloc Sections -->
                                <!-- <div class="mb-2">
                                    <label class="form-label">Sections :</label>
                                    <div id="nm-sections-checkboxes" class="d-flex flex-wrap gap-2"></div>
                                </div> -->
                                <div id="alerte-caci-non-adherent" class="mb-2"></div>
                                <!-- Champs covoiturage juste avant le bouton -->
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label for="nm-covoiturage" class="form-label">Covoiturage</label>
                                        <select name="covoiturage" id="nm-covoiturage" class="form-control">
                                            <option value="">--</option>
                                            <option value="none">Je ne souhaite pas de covoiturage</option>
                                            <option value="propose">Je peux proposer du covoiturage</option>
                                            <option value="besoin">J'aurai besoin de covoiturage</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nm-lieu-covoiturage" class="form-label">Lieu de prise en charge du covoiturage</label>
                                        <input type="text" name="lieu_covoiturage" id="nm-lieu-covoiturage" class="form-control" placeholder="Lieu de prise en charge">
                                    </div>
                                </div>
                                <button id="btn-inscrire-non-adherent" type="submit" class="btn btn-success mt-2">
                                    <span id="btn-inscrire-text">S'inscrire</span>
                                    <span id="btn-inscrire-spinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                        <div id="result-non-adherent" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    // Ajout de la date de la séance dans une variable JS
    const DATE_SEANCE = '{{ seance.date|date:"Y-m-d" }}';
    document.body.setAttribute('data-date-seance', DATE_SEANCE);

    document.getElementById('btn-adherent').onclick = function(e) {
        e.preventDefault();
        document.getElementById('inscription-adherent').style.display = '';
        document.getElementById('inscription-non-adherent').style.display = 'none';
    };
    document.getElementById('btn-non-adherent').onclick = function(e) {
        e.preventDefault();
        document.getElementById('inscription-non-adherent').style.display = '';
        document.getElementById('inscription-adherent').style.display = 'none';
    };
    // Recherche et affichage des adhérents
    let membres = [];
    let membreSelectionne = null;
    function fetchMembres(q = '') {
        fetch('/api/membres-app/?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
                membres = data.membres;
                renderListeMembres();
            });
    }
    function renderListeMembres() {
        const liste = document.getElementById('liste-adherents');
        liste.innerHTML = '';
        membres.forEach(m => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = m.nom + ' ' + m.prenom;
            item.onclick = () => selectMembre(m);
            liste.appendChild(item);
        });
    }
    function selectMembre(m) {
        membreSelectionne = m;
        document.getElementById('infos-adherent').style.display = '';
        // Calcul de la validité du CACI
        let caciMsg = '';
        let caciStyle = '';
        let disableBtn = false;
        let dateDelivrance = m.date_delivrance_caci;
        let dateSeance = DATE_SEANCE;
        let caciDate = null;
        let seanceDate = null;
        if (dateDelivrance) {
            // date_delivrance_caci est au format dd/mm/yyyy
            const parts = dateDelivrance.split('/');
            caciDate = new Date(parts[2], parts[1]-1, parts[0]);
        }
        if (dateSeance) {
            // dateSeance est au format yyyy-mm-dd
            const parts = dateSeance.split('-');
            seanceDate = new Date(parts[0], parts[1]-1, parts[2]);
        }
        if (caciDate && seanceDate) {
            // Date d'expiration = date de délivrance + 1 an
            let expiration = new Date(caciDate);
            expiration.setFullYear(expiration.getFullYear() + 1);
            // Différence en jours entre expiration et date de séance
            const diffDays = (expiration - seanceDate) / (1000*60*60*24);
            if (diffDays < 0) {
                caciMsg = '<span class="fw-bold text-danger">Attention, ton CACI est Expiré, tu ne peux pas t\'inscrire à cette séance.</span>';
                disableBtn = true;
            } else if (diffDays < 31) {
                caciMsg = '<span class="fw-bold" style="color:orange;">Attention ton CACI expire bientôt !</span>';
            }
        }
        document.getElementById('infos-adherent').innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-2">${m.nom} ${m.prenom}</h5>
                    <p class="mb-1"><strong>Niveau :</strong> ${m.niveau}</p>
                    <p class="mb-1"><strong>Section :</strong> ${m.sections.join(', ')}</p>
                    <p class="mb-1"><strong>Statut :</strong> ${m.statut}</p>
                    <p class="mb-1"><strong>Date d'établissement du CACI :</strong> <span id="alerte-caci">${m.date_delivrance_caci}</span><br>${caciMsg}</p>
                    <div class="row mb-2 mt-3">
                        <div class="col-md-6">
                            <label for="ad-covoiturage" class="form-label">Covoiturage</label>
                            <select id="ad-covoiturage" class="form-control">
                                <option value="">--</option>
                                <option value="none">Je ne souhaite pas de covoiturage</option>
                                <option value="propose">Je peux proposer du covoiturage</option>
                                <option value="besoin">J'aurai besoin de covoiturage</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ad-lieu-covoiturage" class="form-label">Lieu de prise en charge du covoiturage</label>
                            <input type="text" id="ad-lieu-covoiturage" class="form-control" placeholder="Lieu de prise en charge">
                        </div>
                    </div>
                    <button class="btn btn-success mt-2" id="btn-inscrire-adherent" onclick="inscrireMembre(${m.id})">S'inscrire</button>
                </div>
            </div>
        `;
        // Désactiver le bouton si CACI expiré
        const btn = document.getElementById('btn-inscrire-adherent');
        if (disableBtn && btn) {
            btn.disabled = true;
        }
    }
    document.getElementById('recherche-adherent').addEventListener('input', function() {
        fetchMembres(this.value);
    });
    // Chargement initial
    fetchMembres();
    // Inscription AJAX (à compléter côté backend)
    window.inscrireMembre = function(id) {
        const uuid = "{{ lien.uuid }}";
        const covoiturage = document.getElementById('ad-covoiturage') ? document.getElementById('ad-covoiturage').value : '';
        const lieu_covoiturage = document.getElementById('ad-lieu-covoiturage') ? document.getElementById('ad-lieu-covoiturage').value : '';
        fetch('/api/inscrire-membre-app/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uuid: uuid, membre_id: id, covoiturage: covoiturage, lieu_covoiturage: lieu_covoiturage })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('infos-adherent').innerHTML += '<div class="alert alert-success mt-3">' + data.message + '</div>';
                // Désactive le bouton S'inscrire
                const btn = document.querySelector('#infos-adherent button');
                if (btn) btn.disabled = true;
            } else {
                document.getElementById('infos-adherent').innerHTML += '<div class="alert alert-danger mt-3">' + data.message + '</div>';
            }
        })
        .catch(() => {
            document.getElementById('infos-adherent').innerHTML += '<div class="alert alert-danger mt-3">Erreur lors de l\'inscription.</div>';
        });
    };

    // Chargement de la liste déroulante des non-adhérents actifs
    function setupNonAdherentSelect() {
        const selectPersonne = document.getElementById('nm-selection-personne');
        const btnCharger = document.getElementById('btn-charger-donnees');
        
        // Charger la liste des non-adhérents actifs
        fetch('/api/liste-non-adherents-actifs/')
            .then(r => r.json())
            .then(data => {
                if (data.non_adherents && data.non_adherents.length > 0) {
                    data.non_adherents.forEach(na => {
                        const option = document.createElement('option');
                        option.value = na.id;
                        option.textContent = na.nom_complet;
                        selectPersonne.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Aucun non-adhérent actif trouvé';
                    option.disabled = true;
                    selectPersonne.appendChild(option);
                }
            })
            .catch(() => {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Erreur lors du chargement';
                option.disabled = true;
                selectPersonne.appendChild(option);
            });
        
        // Activer/désactiver le bouton selon la sélection
        selectPersonne.addEventListener('change', function() {
            btnCharger.disabled = !this.value || this.value === '';
        });
        
        // Fonction pour charger les données d'un non-adhérent
        btnCharger.addEventListener('click', function() {
            const selectedId = selectPersonne.value;
            if (!selectedId) return;
            
            fetch(`/api/details-non-adherent/${selectedId}/`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`Erreur HTTP: ${r.status} ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.success && data.data) {
                        const d = data.data;
                        // Pré-remplir tous les champs
                        document.getElementById('nm-nom').value = d.nom;
                        document.getElementById('nm-prenom').value = d.prenom;
                        document.getElementById('nm-email').value = d.email;
                        document.getElementById('nm-telephone').value = d.telephone;
                        document.getElementById('nm-date-naissance').value = d.date_naissance;
                        document.getElementById('nm-adresse').value = d.adresse || '';
                        document.getElementById('nm-code-postal').value = d.code_postal || '';
                        document.getElementById('nm-ville').value = d.ville || '';
                        document.getElementById('nm-numero-licence').value = d.numero_licence || '';
                        document.getElementById('nm-assurance').value = d.assurance || '';
                        document.getElementById('nm-date-delivrance-caci').value = d.date_delivrance_caci;
                        document.getElementById('nm-niveau').value = d.niveau;
                        document.getElementById('nm-statut').value = d.statut;
                        
                        // Afficher le lien du fichier CACI si présent
                        const blocCaci = document.getElementById('bloc-caci-fields');
                        let caciLink = document.getElementById('caci-fichier-link');
                        const caciInput = document.getElementById('nm-caci-fichier');
                        if (d.caci_fichier_url) {
                            if (!caciLink) {
                                caciLink = document.createElement('a');
                                caciLink.id = 'caci-fichier-link';
                                caciLink.className = 'btn btn-outline-info btn-sm ms-2';
                                caciLink.target = '_blank';
                                caciInput.parentNode.appendChild(caciLink);
                            }
                            caciLink.href = d.caci_fichier_url;
                            caciLink.textContent = 'Télécharger CACI existant';
                            caciLink.style.display = '';
                            // Rendre le champ fichier non requis
                            caciInput.required = false;
                        } else {
                            if (caciLink) caciLink.style.display = 'none';
                            // Rendre le champ fichier requis
                            caciInput.required = true;
                        }
                        
                        // Vérifier l'alerte CACI après chargement
                        checkAlerteCaciNonAdhérent();
                    } else {
                        alert('Erreur lors du chargement des données : ' + (data.error || 'Erreur inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des données:', error);
                    alert('Erreur lors du chargement des données : ' + error.message);
                });
        });
    }
    setupNonAdherentSelect();
    // Alerte CACI si moins d'un mois
    function checkAlerteCaciNonAdhérent() {
        const val = document.getElementById('nm-date-delivrance-caci').value;
        let dateSeance = DATE_SEANCE;
        let disableBtn = false;
        let seanceDate = null;
        const alertDiv = document.getElementById('alerte-caci-non-adherent');
        
        if (dateSeance) {
            // dateSeance est au format yyyy-mm-dd
            const parts = dateSeance.split('-');
            seanceDate = new Date(parts[0], parts[1]-1, parts[2]);
        }
        if (val && seanceDate) {
            const caciDate = new Date(val);
            let expiration = new Date(caciDate);
            expiration.setFullYear(expiration.getFullYear() + 1);
            

            const diff = (expiration - seanceDate) / (1000*60*60*24);
            if (diff < 0) {
                if (alertDiv) {
                    alertDiv.innerHTML = '<span class="badge bg-danger">Attention, ton CACI est expiré, tu ne peux pas t\'inscrire à cette séance.</span>';
                }
                disableBtn = true;
            }
            else if (diff < 31) {
                if (alertDiv) {
                    alertDiv.innerHTML = '<span class="badge bg-danger">Attention, ton CACI expire bientôt !</span>';
                }
            } else {
                if (alertDiv) {
                    alertDiv.innerHTML = '';
                }
            }
        } else {
            // Si pas de date CACI ou pas de date de séance, vider l'alerte
            if (alertDiv) {
                alertDiv.innerHTML = '';
            }
        }

        const btn = document.getElementById('btn-inscrire-non-adherent');
        if (disableBtn && btn) {
            btn.disabled = true;
        }
        else {
            if (btn) {
                btn.disabled = false;
            }
            if (alertDiv) {
                alertDiv.innerHTML = '';
            }
        }
    }
    document.getElementById('nm-date-delivrance-caci').addEventListener('change', checkAlerteCaciNonAdhérent);
    // Affichage dynamique du formulaire non adhérent selon le choix radio
    const radios = document.getElementsByName('type_non_adherent');
    const blocForm = document.getElementById('bloc-form-non-adherent');
    const blocCaci = document.getElementById('bloc-caci-fields');
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            blocForm.style.display = '';
            if (this.value === 'bapteme') {
                blocCaci.style.display = 'none';
                document.getElementById('nm-date-delivrance-caci').required = false;
                document.getElementById('nm-caci-fichier').required = false;
            } else {
                blocCaci.style.display = '';
                document.getElementById('nm-date-delivrance-caci').required = true;
                document.getElementById('nm-caci-fichier').required = true;
            }
        });
    });
    // Validation JS à la soumission
    const formNonAdhérent = document.getElementById('form-non-adherent');
    formNonAdhérent.onsubmit = function(e) {
        e.preventDefault();
        const type = document.querySelector('input[name="type_non_adherent"]:checked');
        if (!type) {
            alert('Merci de sélectionner votre type d\'inscription.');
            return false;
        }
        const caciInput = document.getElementById('nm-caci-fichier');
        const caciLink = document.getElementById('caci-fichier-link');
        if (type.value === 'plongeur') {
            if (!document.getElementById('nm-date-delivrance-caci').value || (!caciInput.value && (!caciLink || caciLink.style.display === 'none'))) {
                alert('Merci de renseigner la date de délivrance et le fichier CACI.');
                return false;
            }
        }
        // Afficher le spinner et désactiver le bouton
        const btnInscrire = document.getElementById('btn-inscrire-non-adherent');
        const btnText = document.getElementById('btn-inscrire-text');
        const btnSpinner = document.getElementById('btn-inscrire-spinner');
        const resultDiv = document.getElementById('result-non-adherent');
        
        btnInscrire.disabled = true;
        btnSpinner.style.display = 'inline-block';
        btnText.textContent = 'Inscription en cours...';
        resultDiv.innerHTML = ''; // Vider les messages précédents
        
        // Soumission AJAX
        const formData = new FormData(formNonAdhérent);
        formData.append('uuid', "{{ lien.uuid }}");
        fetch('/api/inscrire-non-membre/', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            // Masquer le spinner et réactiver le bouton (sauf en cas de succès)
            btnSpinner.style.display = 'none';
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                btnInscrire.disabled = true;
                btnText.textContent = 'Inscription réussie';
                setTimeout(function() { window.location.reload(); }, 5000);
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
                btnInscrire.disabled = false;
                btnText.textContent = 'S\'inscrire';
            }
        })
        .catch(() => {
            // Masquer le spinner et réactiver le bouton en cas d'erreur
            btnSpinner.style.display = 'none';
            btnInscrire.disabled = false;
            btnText.textContent = 'S\'inscrire';
            resultDiv.innerHTML = '<div class="alert alert-danger">Erreur lors de l\'inscription.</div>';
        });
        return false;
    };
</script>
{% endblock %}
